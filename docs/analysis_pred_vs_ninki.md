# 予想順位 vs 人気順位の回収率検証（2025年）

## 検証日: 2026-02-22

## 使用モデル

- LambdaRank（ランキング学習）
- サプリメント: bms_detail + rating
- 学習期間: 2015-2024、検証: 2025年
- 特徴量数: 202
- コマンド: `python run_train.py --supplement bms_detail rating --ranking`

## モデル性能

| 指標 | 値 |
|------|------|
| AUC | 0.7712 |
| NDCG@1 | 0.5470 |
| NDCG@3 | 0.5486 |
| NDCG@5 | 0.6181 |
| top1的中率 | 60.3% |

## 検証1: 予想1位 AND 人気1位の単勝・複勝

予想1位と実際の1番人気が一致した馬だけを購入した場合。

| 項目 | 単勝 | 複勝 |
|------|------|------|
| 対象 | 1,596 / 2,735レース (58.4%) | 同左 |
| 回収率 | **77.1%** | **86.3%** |
| 的中率 | 35.9% (573/1596) | 68.9% (1099/1596) |
| 平均配当 | 215円 | 125円 |

**着順分布:**
1着35.9%, 2着20.2%, 3着13.0%, 3着以内率69.1%

### 比較

| 条件 | 対象数 | 単勝回収率 | 単勝的中率 | 複勝回収率 | 複勝的中率 |
|------|--------|----------|----------|----------|----------|
| 予想1位 AND 人気1位 | 1,596 | 77.1% | 35.9% | 86.3% | 68.9% |
| 予想1位のみ（人気不問） | 2,735 | 87.1% | 29.1% | 85.7% | 60.0% |
| 人気1位のみ（予想不問） | 2,727 | 78.1% | 33.1% | 84.3% | 64.8% |
| **予想1位 AND 人気1位ではない** | **1,139** | **101.2%** | **19.6%** | **84.9%** | **47.5%** |

**発見:** モデル予想1位が1番人気ではない馬の単勝回収率が101.2%と黒字。

## 検証2: 馬単（予想1位→人気1位）

予想1位≠人気1位のレースで、予想1位を1着・人気1位を2着とする馬単。

| 項目 | 値 |
|------|------|
| 対象 | 1,131 / 2,735レース (41.4%) |
| 回収率 | **78.6%** |
| 的中率 | 5.8% (66/1131) |
| 平均配当 | 1,347円 |
| 配当中央値 | 1,160円 |
| 最大配当 | 6,580円 |

参考: 逆順（人気1位→予想1位）は回収率70.1%、的中率6.5%

## 検証3: 馬単（予想1位→予想2位、Top2ともに1番人気ではない）

予想1位≠人気1位 かつ 予想2位≠人気1位のレースで、予想1位→予想2位の馬単。

| 項目 | 値 |
|------|------|
| 対象 | 547 / 2,735レース (20.0%) |
| 回収率 | **66.8%** |
| 的中率 | 2.0% (11/547) |
| 平均配当 | 3,324円 |
| 配当中央値 | 3,090円 |
| 最大配当 | 8,440円 |

**内訳（予想1位≠人気1位の1,131件）:**
- 予想2位=人気1位: 584件 (51.6%)
- 予想2位≠人気1位: 547件 (48.4%)

## 結論

1. **予想と人気の一致は的中率は高いが配当が低く、回収率は最も低い（77.1%）**
2. **予想と人気が割れた時にモデルを信じた単勝が唯一の黒字（101.2%）**
3. 馬単は的中率の低さが足を引っ張り、どのパターンでも赤字
4. モデルの付加価値は「市場と異なる評価をした馬」に集中している

## 改善提案

### 買い方の改善

#### A1: 条件付き単勝のフィルタ最適化（推奨・最優先）

予想1位≠人気1位の1,139レース（回収率101.2%）に対し、さらにフィルタを追加して精度を上げる:

- **確信度フィルタ:** モデルの予想1位と2位のスコア差が大きいレースに絞る
- **人気帯フィルタ:** 予想1位の馬が2-5番人気あたりのゾーン（配当と的中のバランスが良い帯）に絞る
- **EVフィルタ:** オッズ歪み補正後のEV値でフィルタする

#### A2: value_bet戦略との統合

既存のvalue_bet_tansho戦略に「予想1位≠人気1位」の条件を組み合わせることで、現在のev_threshold=1.1より精度の高いフィルタになる可能性がある。

### モデル側の改善

#### B1: 調教師条件別特徴量（v2提案A、未実装・優先度1位）

trainer_codeは重要度3位。芝ダ別/距離帯別/馬場別/直近30日/重賞/休み明けの7特徴量を追加することで、厩舎ごとの得意条件を捕捉。特に「人気薄だが特定条件に強い厩舎」の検出精度が向上する。

#### B2: フォームモメンタム（v2提案D）

着順トレンド傾斜/最終勝利日数/連続3着以内/ピーク比較/改善フラグ/昇級初戦の6特徴量。馬の上昇・下降トレンドを捉え、「市場がまだ気づいていない好調馬」をモデルが先に拾えるようになる可能性。

#### B3: LambdaRankの目的変数チューニング

現在の関連度スコア（1着=5, 2着=4, 3着=3, 4着=2, 5着=1）を1着に重みを寄せる（例: 1着=10, 2着=3, 3着=1, 4着以下=0）ことで、単勝回収率に特化したランキングモデルにする。

### 実装優先順位

1. **A1: 条件付き単勝フィルタ** — 既存データで即検証可能、最も費用対効果が高い
2. **B1: 調教師条件別特徴量** — CLAUDE.mdロードマップの次項目、モデル精度の底上げ
3. **B3: 目的変数チューニング** — 学習パラメータ変更のみ、再学習で即検証可能
4. **B2: フォームモメンタム** — 新特徴量の設計・実装が必要だが効果が期待できる
5. **A2: value_bet統合** — A1の検証結果を踏まえて実装

## 検証スクリプト

`analyze_pred1_ninki1.py` — 本検証の全パターンを一括実行するスクリプト
